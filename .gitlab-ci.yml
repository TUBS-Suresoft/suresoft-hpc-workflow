build_singularity_container:
  image: 
    name: quay.io/singularity/singularity:v3.10.4
    entrypoint: [""]

  stage: build

  tags:
    - linux
    - privileged

  artifacts:
    expire_in: 1 hrs
    paths:
      - Containers/rockylinux9-mpich.sif

  script:
    - singularity build "Containers/rockylinux9-mpich.sif" "Containers/rockylinux9-mpich.def"


###############################################################################
run_hpc_cluster:
  image: python:latest

  stage: test

  needs: ["build_singularity_container"]

  before_script:
    - pip install hpc-rocket

  script:
    - hpc-rocket launch --watch rocket.yml
    - cat results/laplace.out

  artifacts:
    expire_in: 1 hrs
    paths:
      - results/