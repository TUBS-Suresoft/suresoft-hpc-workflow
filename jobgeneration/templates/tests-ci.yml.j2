stages: 
  - test

deploy-singularity-mpich-bind:
  stage: test
  image: python:3.10

  script:
   - rsync -e "ssh -i $PRIVATE_KEY" "Containers/rockylinux9-mpich-bind.sif" "$REMOTE_USER@$REMOTE_HOST:Containers/rockylinux9-mpich-bind.sif"

  needs:
    - pipeline: $PARENT_PIPELINE_ID
      job: build-singularity-mpich-bind


{% for test_case in test_cases %}
run-{{ test_case }}:
  stage: test
  image: python:3.10

  variables:
    TEST_SCRIPT: {{ test_case }}

  before_script:
    - pip install hpc-rocket==0.4.0

  script:
    - hpc-rocket launch tests/rocket.yml |& tee hpcrocket.log
    - hpc-rocket watch tests/rocket.yml $(python parsejobid.py hpcrocket.log)
    - hpc-rocket finalize tests/rocket.yml
    - cat results/{{ test_case }}.out

  after_script:
    - hpc-rocket cancel tests/rocket.yml $(python parsejobid.py hpcrocket.log)

  artifacts:
    expire_in: 1 hrs
    paths:
      - results/

  needs:
    - deploy-singularity-mpich-bind


assert-{{ test_case }}:
  stage: test
  image: python3.10
  before_script:
    - pip install fieldcompare
    
  script:
    - fieldcompare dir results reference_data --include-files "*.vtu"

  needs:
    - run-{{ test_case }}

{% endfor %}
